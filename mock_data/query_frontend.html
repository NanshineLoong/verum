<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Engine - æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .query-section {
            margin-bottom: 30px;
        }

        .query-section label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .query-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        .query-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 15px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            display: none;
            margin-top: 30px;
        }

        .result-section.active {
            display: block;
        }

        .result-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .report-content {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 600px;
            overflow-y: auto;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #c33;
            margin-top: 20px;
        }

        .api-config {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }

        .api-config input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .mode-selector {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .mode-selector label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .mode-options {
            display: flex;
            gap: 15px;
        }

        .mode-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .mode-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .mode-option input[type="radio"] {
            margin-right: 8px;
        }

        .mode-option.selected {
            border-color: #667eea;
            background: #e8edff;
            font-weight: 600;
        }

        .verification-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .verification-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .verification-result {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .verdict-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .verdict-true {
            background: #d4edda;
            color: #155724;
        }

        .verdict-false {
            background: #f8d7da;
            color: #721c24;
        }

        .verdict-partial {
            background: #fff3cd;
            color: #856404;
        }

        .verdict-unknown {
            background: #e2e3e5;
            color: #383d41;
        }

        .verification-summary {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            line-height: 1.6;
            color: #555;
        }

        .verification-actions {
            margin-top: 20px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            border: 1px solid #667eea;
        }

        .verification-actions h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .verification-btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
        }

        .verification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .verification-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .standalone-verification {
            margin-top: 30px;
            padding: 20px;
            background: #fff9e6;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .standalone-verification h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .standalone-verification textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-height: 100px;
        }

        .result-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .result-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .result-tab:hover {
            color: #667eea;
        }

        .result-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .timeline-section {
            margin-top: 20px;
        }

        .timeline-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .timeline-stats {
            padding: 15px;
            background: #f0f4ff;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #555;
        }

        .timeline-stats span {
            font-weight: 600;
            color: #667eea;
        }

        .timeline-item {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-left: 4px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .timeline-date {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .timeline-event {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .timeline-event-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .timeline-event-description {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .timeline-sources {
            margin-top: 10px;
        }

        .timeline-sources-title {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        .timeline-source-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }

        .timeline-source-item a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .timeline-source-item a:hover {
            text-decoration: underline;
        }

        .timeline-source-score {
            font-size: 12px;
            color: #999;
            margin-left: 8px;
        }

        .timeline-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Query Engine</h1>
            <p>æ™ºèƒ½æŸ¥è¯¢ç³»ç»Ÿ - åŸºäºæ·±åº¦æœç´¢çš„AIä»£ç†</p>
        </div>

        <div class="content">
            <div class="query-section">
                <label for="queryInput">è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š</label>
                <textarea 
                    id="queryInput" 
                    class="query-input" 
                    rows="4" 
                    placeholder="ä¾‹å¦‚ï¼šæ­¦æ±‰å¤§å­¦æœ€è¿‘çš„èˆ†æƒ…æƒ…å†µå¦‚ä½•ï¼Ÿ"
                ></textarea>
                
                <div class="mode-selector">
                    <label>æ€è€ƒæ¨¡å¼ï¼š</label>
                    <div class="mode-options">
                        <label class="mode-option selected" for="modeDeep">
                            <input type="radio" id="modeDeep" name="mode" value="deep" checked>
                            ğŸ§  æ·±åº¦æ€è€ƒï¼ˆæ›´å…¨é¢ï¼Œè€—æ—¶è¾ƒé•¿ï¼‰
                        </label>
                        <label class="mode-option" for="modeQuick">
                            <input type="radio" id="modeQuick" name="mode" value="quick">
                            âš¡ æµ…åº¦æ€è€ƒï¼ˆå¿«é€Ÿå“åº”ï¼‰
                        </label>
                    </div>
                </div>
                
                <button id="submitBtn" class="submit-btn">å¼€å§‹æŸ¥è¯¢</button>
            </div>

            <div class="api-config">
                <label>API åœ°å€ï¼ˆå¯é€‰ï¼Œé»˜è®¤: http://localhost:6001ï¼‰:</label>
                <input type="text" id="apiUrl" value="http://localhost:6001" placeholder="http://localhost:6001">
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="result-section" id="resultSection">
                <div class="result-tabs">
                    <button class="result-tab active" data-tab="report">ğŸ“„ æŠ¥å‘Š</button>
                    <button class="result-tab" data-tab="timeline">ğŸ“… æ—¶é—´çº¿</button>
                    <button class="result-tab" data-tab="verification">âš–ï¸ åˆ¤ç½š</button>
                </div>
                
                <div class="tab-content active" id="reportTab">
                    <div class="result-header">ğŸ“„ æŸ¥è¯¢æŠ¥å‘Š</div>
                    <div class="report-content" id="reportContent"></div>
                </div>
                
                <div class="tab-content" id="timelineTab">
                    <div class="timeline-section">
                        <div class="timeline-header">ğŸ“… æ–°é—»æ—¶é—´çº¿</div>
                        <div class="timeline-loading" id="timelineLoading" style="display: none;">
                            <div class="spinner"></div>
                            <p>æ­£åœ¨ç”Ÿæˆæ—¶é—´çº¿...</p>
                        </div>
                        <div id="timelineContent"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="verificationTab">
                    <div class="verification-section" id="verificationSection" style="display: none;">
                        <div class="verification-header">âš–ï¸ æ–°é—»çœŸå‡åˆ¤åˆ«ç»“æœ</div>
                        <div class="verification-result">
                            <span class="verdict-badge" id="verdictBadge">æ— æ³•ç¡®å®š</span>
                            <span id="verdictText">æ— æ³•ç¡®å®š</span>
                        </div>
                        <div class="verification-summary">
                            <strong>åˆ¤åˆ«æ‘˜è¦ï¼š</strong>
                            <div id="verificationSummary">æš‚æ— åˆ¤åˆ«æ‘˜è¦</div>
                        </div>
                        
                        <div class="verification-actions">
                            <h3>ğŸ” åˆ¤ç½šæ“ä½œ</h3>
                            <button class="verification-btn" id="reverifyBtn">é‡æ–°åˆ¤ç½š</button>
                            <button class="verification-btn" id="standaloneVerifyBtn">ç‹¬ç«‹åˆ¤ç½š</button>
                        </div>
                    </div>
                    
                    <div class="standalone-verification" id="standaloneVerification" style="display: none;">
                        <h3>ğŸ“ ç‹¬ç«‹åˆ¤ç½šæœåŠ¡</h3>
                        <p style="margin-bottom: 10px; color: #666;">æ‚¨å¯ä»¥è¾“å…¥æŸ¥è¯¢å†…å®¹å’ŒæŠ¥å‘Šå†…å®¹ï¼Œå•ç‹¬è¿›è¡Œåˆ¤ç½šï¼š</p>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">æŸ¥è¯¢å†…å®¹ï¼š</label>
                        <textarea id="standaloneQuery" placeholder="è¯·è¾“å…¥åŸå§‹æŸ¥è¯¢æˆ–æ–°é—»å†…å®¹"></textarea>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; margin-top: 10px;">ç ”ç©¶æŠ¥å‘Šï¼š</label>
                        <textarea id="standaloneReport" placeholder="è¯·è¾“å…¥ç ”ç©¶æŠ¥å‘Šå†…å®¹"></textarea>
                        <button class="verification-btn" id="submitStandaloneBtn">æ‰§è¡Œåˆ¤ç½š</button>
                        <button class="verification-btn" style="background: #6c757d;" id="cancelStandaloneBtn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </div>
    </div>

    <script>
        const queryInput = document.getElementById('queryInput');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const resultSection = document.getElementById('resultSection');
        const reportContent = document.getElementById('reportContent');
        const errorMessage = document.getElementById('errorMessage');
        const apiUrlInput = document.getElementById('apiUrl');
        const verificationSection = document.getElementById('verificationSection');
        const verdictBadge = document.getElementById('verdictBadge');
        const verdictText = document.getElementById('verdictText');
        const verificationSummary = document.getElementById('verificationSummary');
        const reverifyBtn = document.getElementById('reverifyBtn');
        const standaloneVerifyBtn = document.getElementById('standaloneVerifyBtn');
        const standaloneVerification = document.getElementById('standaloneVerification');
        const standaloneQuery = document.getElementById('standaloneQuery');
        const standaloneReport = document.getElementById('standaloneReport');
        const submitStandaloneBtn = document.getElementById('submitStandaloneBtn');
        const cancelStandaloneBtn = document.getElementById('cancelStandaloneBtn');
        const timelineContent = document.getElementById('timelineContent');
        const timelineLoading = document.getElementById('timelineLoading');
        let pollingInterval = null;
        let currentTaskId = null;
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.result-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const targetTab = this.getAttribute('data-tab');
                
                // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                document.querySelectorAll('.result-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // æ›´æ–°å†…å®¹æ˜¾ç¤º
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(targetTab + 'Tab').classList.add('active');
                
                // å¦‚æœåˆ‡æ¢åˆ°æ—¶é—´çº¿æ ‡ç­¾ï¼Œè‡ªåŠ¨åŠ è½½æ—¶é—´çº¿
                if (targetTab === 'timeline' && currentTaskId) {
                    loadTimeline(currentTaskId);
                }
            });
        });

        // æ¨¡å¼é€‰æ‹©å™¨äº¤äº’
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.closest('.mode-option').classList.add('selected');
            });
        });

        // è½®è¯¢ä»»åŠ¡çŠ¶æ€
        async function pollTaskStatus(apiUrl, taskId) {
            try {
                const response = await fetch(`${apiUrl}/api/query/${taskId}/status`);
                const data = await response.json();
                
                if (data.success && data.task) {
                    const task = data.task;
                    
                    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                    const loadingText = loading.querySelector('p');
                    if (loadingText) {
                        loadingText.textContent = `æ­£åœ¨ç”ŸæˆæŠ¥å‘Šï¼Œè¯·ç¨å€™... (${task.progress}%)`;
                    }
                    
                    // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
                    if (task.status === 'completed') {
                        // ä»»åŠ¡å®Œæˆï¼Œè·å–ç»“æœ
                        clearInterval(pollingInterval);
                        await fetchTaskResult(apiUrl, taskId);
                    } else if (task.status === 'error') {
                        // ä»»åŠ¡å¤±è´¥
                        clearInterval(pollingInterval);
                        errorMessage.textContent = `é”™è¯¯: ${task.error_message || 'æœªçŸ¥é”™è¯¯'}`;
                        errorMessage.style.display = 'block';
                        resultSection.classList.remove('active');
                        loading.classList.remove('active');
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
                    }
                    // å¦‚æœçŠ¶æ€æ˜¯ pending æˆ– runningï¼Œç»§ç»­è½®è¯¢
                } else {
                    throw new Error(data.error || 'è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                clearInterval(pollingInterval);
                errorMessage.textContent = `è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`;
                errorMessage.style.display = 'block';
                loading.classList.remove('active');
                submitBtn.disabled = false;
                submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
            }
        }

        // è·å–ä»»åŠ¡ç»“æœ
        async function fetchTaskResult(apiUrl, taskId) {
            try {
                const response = await fetch(`${apiUrl}/api/query/${taskId}`);
                const data = await response.json();
                
                if (data.success) {
                    // æ˜¾ç¤ºæŠ¥å‘Šç»“æœ
                    reportContent.textContent = data.report;
                    resultSection.classList.add('active');
                    errorMessage.style.display = 'none';
                    
                    // æ˜¾ç¤ºåˆ¤ç½šç»“æœ
                    if (data.verification) {
                        displayVerification(data.verification);
                        verificationSection.style.display = 'block';
                    } else {
                        verificationSection.style.display = 'none';
                    }
                } else {
                    // æ˜¾ç¤ºé”™è¯¯
                    errorMessage.textContent = `é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
                    errorMessage.style.display = 'block';
                    resultSection.classList.remove('active');
                    verificationSection.style.display = 'none';
                }
            } catch (error) {
                errorMessage.textContent = `è·å–ç»“æœå¤±è´¥: ${error.message}`;
                errorMessage.style.display = 'block';
                verificationSection.style.display = 'none';
            } finally {
                loading.classList.remove('active');
                submitBtn.disabled = false;
                submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
            }
        }

        // æ˜¾ç¤ºåˆ¤ç½šç»“æœ
        function displayVerification(verification) {
            if (!verification) {
                verificationSection.style.display = 'none';
                return;
            }

            const verdict = verification.verdict || 'æ— æ³•ç¡®å®š';
            const summary = verification.summary || 'æš‚æ— åˆ¤åˆ«æ‘˜è¦';

            // æ›´æ–°åˆ¤ç½šç»“æœæ–‡æœ¬
            verdictText.textContent = verdict;

            // æ›´æ–°åˆ¤ç½šå¾½ç« æ ·å¼
            verdictBadge.textContent = verdict;
            verdictBadge.className = 'verdict-badge ';
            
            const emojiMap = {
                'çœŸ': 'âœ…',
                'å‡': 'âŒ',
                'éƒ¨åˆ†çœŸå®': 'âš ï¸',
                'æ— æ³•ç¡®å®š': 'â“'
            };
            
            const emoji = emojiMap[verdict] || 'â“';
            verdictBadge.textContent = `${emoji} ${verdict}`;

            if (verdict === 'çœŸ') {
                verdictBadge.className += 'verdict-true';
            } else if (verdict === 'å‡') {
                verdictBadge.className += 'verdict-false';
            } else if (verdict === 'éƒ¨åˆ†çœŸå®') {
                verdictBadge.className += 'verdict-partial';
            } else {
                verdictBadge.className += 'verdict-unknown';
            }

            // æ›´æ–°æ‘˜è¦
            verificationSummary.textContent = summary;

            // æ˜¾ç¤ºåˆ¤ç½šåŒºåŸŸ
            verificationSection.style.display = 'block';
        }

        submitBtn.addEventListener('click', async () => {
            const query = queryInput.value.trim();
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }

            // éšè—ä¹‹å‰çš„ç»“æœå’Œé”™è¯¯
            resultSection.classList.remove('active');
            errorMessage.style.display = 'none';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.classList.add('active');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æŸ¥è¯¢ä¸­...';

            try {
                const apiUrl = apiUrlInput.value.trim() || 'http://localhost:6001';
                
                // è·å–é€‰æ‹©çš„æ¨¡å¼
                const selectedMode = document.querySelector('input[name="mode"]:checked').value;
                
                // åˆ›å»ºæŸ¥è¯¢ä»»åŠ¡
                const response = await fetch(`${apiUrl}/api/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        query: query,
                        mode: selectedMode
                    })
                });

                const data = await response.json();

                if (data.success && data.task_id) {
                    // ä¿å­˜å½“å‰ä»»åŠ¡ID
                    currentTaskId = data.task_id;
                    
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    const taskId = data.task_id;
                    pollingInterval = setInterval(() => {
                        pollTaskStatus(apiUrl, taskId);
                    }, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
                    
                    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
                    pollTaskStatus(apiUrl, taskId);
                } else {
                    // æ˜¾ç¤ºé”™è¯¯
                    errorMessage.textContent = `é”™è¯¯: ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
                    errorMessage.style.display = 'block';
                    resultSection.classList.remove('active');
                    loading.classList.remove('active');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
                }
            } catch (error) {
                // æ˜¾ç¤ºç½‘ç»œé”™è¯¯
                errorMessage.textContent = `ç½‘ç»œé”™è¯¯: ${error.message}`;
                errorMessage.style.display = 'block';
                resultSection.classList.remove('active');
                loading.classList.remove('active');
                submitBtn.disabled = false;
                submitBtn.textContent = 'å¼€å§‹æŸ¥è¯¢';
            }
        });

        // é‡æ–°åˆ¤ç½šæŒ‰é’®
        reverifyBtn.addEventListener('click', async () => {
            if (!currentTaskId) {
                alert('æ²¡æœ‰å¯ç”¨çš„ä»»åŠ¡ID');
                return;
            }
            
            const apiUrl = apiUrlInput.value.trim() || 'http://localhost:6001';
            await performVerification(apiUrl, null, null, currentTaskId);
        });

        // ç‹¬ç«‹åˆ¤ç½šæŒ‰é’®
        standaloneVerifyBtn.addEventListener('click', () => {
            standaloneVerification.style.display = 'block';
            // å¦‚æœå·²æœ‰æŠ¥å‘Šï¼Œè‡ªåŠ¨å¡«å……
            if (reportContent.textContent) {
                standaloneReport.value = reportContent.textContent;
            }
            if (queryInput.value) {
                standaloneQuery.value = queryInput.value;
            }
        });

        // å–æ¶ˆç‹¬ç«‹åˆ¤ç½š
        cancelStandaloneBtn.addEventListener('click', () => {
            standaloneVerification.style.display = 'none';
            standaloneQuery.value = '';
            standaloneReport.value = '';
        });

        // æäº¤ç‹¬ç«‹åˆ¤ç½š
        submitStandaloneBtn.addEventListener('click', async () => {
            const query = standaloneQuery.value.trim();
            const report = standaloneReport.value.trim();
            
            if (!query) {
                alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
                return;
            }
            
            if (!report) {
                alert('è¯·è¾“å…¥ç ”ç©¶æŠ¥å‘Šå†…å®¹');
                return;
            }
            
            const apiUrl = apiUrlInput.value.trim() || 'http://localhost:6001';
            await performVerification(apiUrl, query, report, null);
        });

        // æ‰§è¡Œåˆ¤ç½šçš„é€šç”¨å‡½æ•°
        async function performVerification(apiUrl, query, report, taskId) {
            try {
                reverifyBtn.disabled = true;
                submitStandaloneBtn.disabled = true;
                reverifyBtn.textContent = 'åˆ¤ç½šä¸­...';
                submitStandaloneBtn.textContent = 'åˆ¤ç½šä¸­...';
                
                const requestBody = {};
                if (taskId) {
                    requestBody.task_id = taskId;
                } else {
                    requestBody.query = query;
                    requestBody.report = report;
                }
                
                const response = await fetch(`${apiUrl}/api/verification`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success && data.verification) {
                    // æ˜¾ç¤ºåˆ¤ç½šç»“æœ
                    displayVerification(data.verification);
                    // å¦‚æœæ˜¯ä»ç‹¬ç«‹åˆ¤ç½šæ¥çš„ï¼Œéšè—ç‹¬ç«‹åˆ¤ç½šåŒºåŸŸ
                    if (!taskId) {
                        standaloneVerification.style.display = 'none';
                    }
                } else {
                    alert(`åˆ¤ç½šå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                alert(`åˆ¤ç½šè¯·æ±‚å¤±è´¥: ${error.message}`);
            } finally {
                reverifyBtn.disabled = false;
                submitStandaloneBtn.disabled = false;
                reverifyBtn.textContent = 'é‡æ–°åˆ¤ç½š';
                submitStandaloneBtn.textContent = 'æ‰§è¡Œåˆ¤ç½š';
            }
        }

        // åŠ è½½æ—¶é—´çº¿
        async function loadTimeline(taskId) {
            if (!taskId) {
                timelineContent.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">æš‚æ— æ—¶é—´çº¿æ•°æ®</p>';
                return;
            }
            
            try {
                timelineLoading.style.display = 'block';
                timelineContent.innerHTML = '';
                
                const apiUrl = apiUrlInput.value.trim() || 'http://localhost:6001';
                const response = await fetch(`${apiUrl}/api/timeline/query/${taskId}`);
                const data = await response.json();
                
                timelineLoading.style.display = 'none';
                
                if (data.success && data.timeline) {
                    displayTimeline(data);
                } else {
                    timelineContent.innerHTML = `<p style="color: #c33; text-align: center; padding: 40px;">${data.error || 'åŠ è½½æ—¶é—´çº¿å¤±è´¥'}</p>`;
                }
            } catch (error) {
                timelineLoading.style.display = 'none';
                timelineContent.innerHTML = `<p style="color: #c33; text-align: center; padding: 40px;">åŠ è½½æ—¶é—´çº¿å¤±è´¥: ${error.message}</p>`;
            }
        }
        
        // æ˜¾ç¤ºæ—¶é—´çº¿
        function displayTimeline(timelineData) {
            const timeline = timelineData.timeline || [];
            const totalSources = timelineData.total_sources || 0;
            const dateRange = timelineData.date_range;
            
            let html = '';
            
            // ç»Ÿè®¡ä¿¡æ¯
            if (dateRange || totalSources > 0) {
                html += '<div class="timeline-stats">';
                if (dateRange) {
                    html += `<div><span>æ—¶é—´èŒƒå›´:</span> ${dateRange.start} - ${dateRange.end}</div>`;
                }
                if (totalSources > 0) {
                    html += `<div><span>å‚è€ƒæ–‡ç« æ€»æ•°:</span> ${totalSources} ç¯‡</div>`;
                }
                html += '</div>';
            }
            
            if (timeline.length === 0) {
                html += '<p style="color: #999; text-align: center; padding: 40px;">æš‚æ— æ—¶é—´çº¿æ•°æ®</p>';
                timelineContent.innerHTML = html;
                return;
            }
            
            // æ—¶é—´çº¿å†…å®¹
            timeline.forEach(item => {
                const date = item.date || 'æœªçŸ¥æ—¥æœŸ';
                const events = item.events || [];
                const sourceCount = item.source_count || 0;
                
                html += `<div class="timeline-item">`;
                html += `<div class="timeline-date">${date} (${sourceCount}ç¯‡)</div>`;
                
                events.forEach(event => {
                    const title = event.title || 'æ— æ ‡é¢˜';
                    const description = event.description || '';
                    const time = event.time || '';
                    const sources = event.sources || [];
                    
                    html += `<div class="timeline-event">`;
                    // æ˜¾ç¤ºæ ‡é¢˜å’Œæ—¶é—´
                    const timeText = time ? ` <span style="color: #999; font-size: 14px; font-weight: normal;">(${time})</span>` : '';
                    html += `<div class="timeline-event-title">${title}${timeText}</div>`;
                    
                    if (description) {
                        html += `<div class="timeline-event-description">${description}</div>`;
                    }
                    
                    if (sources.length > 0) {
                        html += `<div class="timeline-sources">`;
                        html += `<div class="timeline-sources-title">å‚è€ƒæ–‡ç« ï¼š</div>`;
                        
                        sources.forEach(source => {
                            const sourceTitle = source.title || 'æ— æ ‡é¢˜';
                            const sourceUrl = source.url || '';
                            const websiteName = source.website_name || '';
                            const score = source.score;
                            
                            // æ„å»ºæ˜¾ç¤ºæ–‡æœ¬ï¼šæ ‡é¢˜ - ç½‘ç«™åç§° (ç›¸å…³åº¦)
                            const parts = [];
                            if (sourceUrl) {
                                parts.push(`<a href="${sourceUrl}" target="_blank">${sourceTitle}</a>`);
                            } else {
                                parts.push(sourceTitle);
                            }
                            
                            if (websiteName) {
                                parts.push(`<span style="color: #666; margin-left: 5px;">- ${websiteName}</span>`);
                            }
                            
                            if (score) {
                                parts.push(`<span class="timeline-source-score">(ç›¸å…³åº¦: ${score.toFixed(2)})</span>`);
                            }
                            
                            html += `<div class="timeline-source-item">${parts.join(' ')}</div>`;
                        });
                        
                        html += `</div>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            timelineContent.innerHTML = html;
        }
        
        // æ”¯æŒå›è½¦é”®æäº¤ï¼ˆCtrl+Enter æˆ– Cmd+Enterï¼‰
        queryInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                submitBtn.click();
            }
        });
    </script>
</body>
</html>

